edition = "2023";

package otterscale.storage.v1;

import "api/annotations.proto";
import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";

option go_package = "github.com/otterscale/otterscale/api/storage/v1;pb";

service StorageService {
  rpc ListMonitors(ListMonitorsRequest) returns (ListMonitorsResponse) {
    option (otterscale.api.feature) = {
      name: "stg-general"
    };
  };

  rpc ListObjectStorageDaemons(ListObjectStorageDaemonsRequest) returns (ListObjectStorageDaemonsResponse) {
    option (otterscale.api.feature) = {
      name: "stg-general"
    };
  };

  rpc DoSMART(DoSMARTRequest) returns (DoSMARTResponse) {
    option (otterscale.api.feature) = {
      name: "stg-general"
    };
  };

  rpc ListPools(ListPoolsRequest) returns (ListPoolsResponse) {
    option (otterscale.api.feature) = {
      name: "stg-general"
    };
  };

  rpc CreatePool(CreatePoolRequest) returns (Pool) {
    option (otterscale.api.feature) = {
      name: "stg-general"
    };
  };

  rpc UpdatePool(UpdatePoolRequest) returns (Pool) {
    option (otterscale.api.feature) = {
      name: "stg-general"
    };
  };

  rpc DeletePool(DeletePoolRequest) returns (google.protobuf.Empty) {
    option (otterscale.api.feature) = {
      name: "stg-general"
    };
  };

  rpc ListImages(ListImagesRequest) returns (ListImagesResponse) {
    option (otterscale.api.feature) = {
      name: "stg-block"
    };
  };

  rpc CreateImage(CreateImageRequest) returns (Image) {
    option (otterscale.api.feature) = {
      name: "stg-block"
    };
  };

  rpc UpdateImage(UpdateImageRequest) returns (Image) {
    option (otterscale.api.feature) = {
      name: "stg-block"
    };
  };

  rpc DeleteImage(DeleteImageRequest) returns (google.protobuf.Empty) {
    option (otterscale.api.feature) = {
      name: "stg-block"
    };
  };

  rpc CreateImageSnapshot(CreateImageSnapshotRequest) returns (Image.Snapshot) {
    option (otterscale.api.feature) = {
      name: "stg-block"
    };
  };

  rpc DeleteImageSnapshot(DeleteImageSnapshotRequest) returns (google.protobuf.Empty) {
    option (otterscale.api.feature) = {
      name: "stg-block"
    };
  };

  rpc RollbackImageSnapshot(RollbackImageSnapshotRequest) returns (google.protobuf.Empty) {
    option (otterscale.api.feature) = {
      name: "stg-block"
    };
  };

  rpc ProtectImageSnapshot(ProtectImageSnapshotRequest) returns (google.protobuf.Empty) {
    option (otterscale.api.feature) = {
      name: "stg-block"
    };
  };

  rpc UnprotectImageSnapshot(UnprotectImageSnapshotRequest) returns (google.protobuf.Empty) {
    option (otterscale.api.feature) = {
      name: "stg-block"
    };
  };

  rpc ListVolumes(ListVolumesRequest) returns (ListVolumesResponse) {
    option (otterscale.api.feature) = {
      name: "stg-file"
    };
  };

  rpc ListSubvolumes(ListSubvolumesRequest) returns (ListSubvolumesResponse) {
    option (otterscale.api.feature) = {
      name: "stg-file"
    };
  };

  rpc CreateSubvolume(CreateSubvolumeRequest) returns (Subvolume) {
    option (otterscale.api.feature) = {
      name: "stg-file"
    };
  };

  rpc UpdateSubvolume(UpdateSubvolumeRequest) returns (Subvolume) {
    option (otterscale.api.feature) = {
      name: "stg-file"
    };
  };

  rpc DeleteSubvolume(DeleteSubvolumeRequest) returns (google.protobuf.Empty) {
    option (otterscale.api.feature) = {
      name: "stg-file"
    };
  };

  rpc GrantSubvolumeExportAccess(GrantSubvolumeExportAccessRequest) returns (google.protobuf.Empty) {
    option (otterscale.api.feature) = {
      name: "stg-file"
    };
  };

  rpc RevokeSubvolumeExportAccess(RevokeSubvolumeExportAccessRequest) returns (google.protobuf.Empty) {
    option (otterscale.api.feature) = {
      name: "stg-file"
    };
  };

  rpc CreateSubvolumeSnapshot(CreateSubvolumeSnapshotRequest) returns (Subvolume.Snapshot) {
    option (otterscale.api.feature) = {
      name: "stg-file"
    };
  };

  rpc DeleteSubvolumeSnapshot(DeleteSubvolumeSnapshotRequest) returns (google.protobuf.Empty) {
    option (otterscale.api.feature) = {
      name: "stg-file"
    };
  };

  rpc ListSubvolumeGroups(ListSubvolumeGroupsRequest) returns (ListSubvolumeGroupsResponse) {
    option (otterscale.api.feature) = {
      name: "stg-file"
    };
  };

  rpc CreateSubvolumeGroup(CreateSubvolumeGroupRequest) returns (SubvolumeGroup) {
    option (otterscale.api.feature) = {
      name: "stg-file"
    };
  };

  rpc UpdateSubvolumeGroup(UpdateSubvolumeGroupRequest) returns (SubvolumeGroup) {
    option (otterscale.api.feature) = {
      name: "stg-file"
    };
  };

  rpc DeleteSubvolumeGroup(DeleteSubvolumeGroupRequest) returns (google.protobuf.Empty) {
    option (otterscale.api.feature) = {
      name: "stg-file"
    };
  };

  rpc ListBuckets(ListBucketsRequest) returns (ListBucketsResponse) {
    option (otterscale.api.feature) = {
      name: "stg-object"
    };
  };

  rpc CreateBucket(CreateBucketRequest) returns (Bucket) {
    option (otterscale.api.feature) = {
      name: "stg-object"
    };
  };

  rpc UpdateBucket(UpdateBucketRequest) returns (Bucket) {
    option (otterscale.api.feature) = {
      name: "stg-object"
    };
  };

  rpc DeleteBucket(DeleteBucketRequest) returns (google.protobuf.Empty) {
    option (otterscale.api.feature) = {
      name: "stg-object"
    };
  };

  rpc ListUsers(ListUsersRequest) returns (ListUsersResponse) {
    option (otterscale.api.feature) = {
      name: "stg-object"
    };
  };

  rpc CreateUser(CreateUserRequest) returns (User) {
    option (otterscale.api.feature) = {
      name: "stg-object"
    };
  };

  rpc UpdateUser(UpdateUserRequest) returns (User) {
    option (otterscale.api.feature) = {
      name: "stg-object"
    };
  };

  rpc DeleteUser(DeleteUserRequest) returns (google.protobuf.Empty) {
    option (otterscale.api.feature) = {
      name: "stg-object"
    };
  };

  rpc CreateUserKey(CreateUserKeyRequest) returns (User.Key) {
    option (otterscale.api.feature) = {
      name: "stg-object"
    };
  };

  rpc DeleteUserKey(DeleteUserKeyRequest) returns (google.protobuf.Empty) {
    option (otterscale.api.feature) = {
      name: "stg-object"
    };
  };

  rpc ListSMBShares(ListSMBSharesRequest) returns (ListSMBSharesResponse) {
    option (otterscale.api.feature) = {
      name: "stg-smb"
    };
  };

  rpc CreateSMBShare(CreateSMBShareRequest) returns (SMBShare) {
    option (otterscale.api.feature) = {
      name: "stg-smb"
    };
  };

  rpc UpdateSMBShare(UpdateSMBShareRequest) returns (SMBShare) {
    option (otterscale.api.feature) = {
      name: "stg-smb"
    };
  };

  rpc ValidateSMBUser(ValidateSMBUserRequest) returns (ValidateSMBUserResponse) {
    option (otterscale.api.feature) = {
      name: "stg-smb"
    };
  };
}

enum PoolType {
  UNSPECIFIED = 0;
  ERASURE = 1;
  REPLICATED = 2;
}

message Machine {
  string id = 1;
  string hostname = 2;
}

message Monitor {
  bool leader = 1;
  string name = 2;
  uint64 rank = 3;
  string public_address = 4;
  Machine machine = 101;
}

message ObjectStorageDaemon {
  int64 id = 1;
  string name = 2;
  bool up = 3;
  bool in = 4;
  bool exists = 5;
  string device_class = 11;
  uint64 size_bytes = 12;
  uint64 used_bytes = 13;
  uint64 placement_group_count = 21;
  Machine machine = 101;
}

message Pool {
  int64 id = 1;
  string name = 2;
  bool updating = 3;
  PoolType pool_type = 11;
  bool ec_overwrites = 21;      // erasure
  uint64 data_chunks = 22;      // erasure k
  uint64 coding_chunks = 23;    // erasure m
  uint64 replicated_size = 31;  // replicated
  uint64 quota_bytes = 41;
  uint64 quota_objects = 42;
  uint64 used_bytes = 43;
  uint64 used_objects = 44;
  uint64 max_bytes = 45;
  uint64 placement_group_count = 51;
  map<string, int64> placement_group_state = 52;
  google.protobuf.Timestamp created_at = 61;
  repeated string applications = 71;
}

message Image {
  message Snapshot {
    string name = 1;
    bool protected = 2;
    uint64 quota_bytes = 3;
    uint64 used_bytes = 4;
  }
  string name = 1;
  string pool_name = 11;
  uint64 object_size_bytes = 21;
  uint64 stripe_unit_bytes = 22;
  uint64 stripe_count = 23;
  uint64 quota_bytes = 31;
  uint64 used_bytes = 32;
  uint64 object_count = 33;
  bool layering = 41;
  bool exclusive_lock = 42;
  bool object_map = 43;
  bool fast_diff = 44;
  bool deep_flatten = 45;
  google.protobuf.Timestamp created_at = 51;
  repeated Snapshot snapshots = 101;
}

message Volume {
  int64 id = 1;
  string name = 2;
  google.protobuf.Timestamp created_at = 11;
}

message Subvolume {
  message Snapshot {
    string name = 1;
    string has_pending_clones = 2;
    google.protobuf.Timestamp created_at = 11;
  }
  message Export {
    string ip = 1;
    string path = 2;
    repeated string clients = 3;
    string command = 11;
  }
  string name = 1;
  string path = 2;
  string mode = 11;  // oct
  string pool_name = 12;
  uint64 quota_bytes = 21;
  uint64 used_bytes = 22;
  google.protobuf.Timestamp created_at = 31;
  Export export = 51;
  repeated Snapshot snapshots = 101;
}

message SubvolumeGroup {
  string name = 1;
  string mode = 11;  // oct
  string pool_name = 12;
  uint64 quota_bytes = 21;
  uint64 used_bytes = 22;
  google.protobuf.Timestamp created_at = 31;
}

message Bucket {
  enum ACL {
    PRIVATE = 0;
    PUBLIC_READ = 1;
    PUBLIC_READ_WRITE = 2;
    AUTHENTICATED_READ = 3;
  }
  message Grant {
    string type = 1;
    string id = 2;
    string name = 3;
    string uri = 4;
    string permission = 5;
  }
  string name = 1;
  string owner = 2;
  string policy = 21;
  repeated Grant grants = 22;
  uint64 used_bytes = 33;
  uint64 used_objects = 34;
  google.protobuf.Timestamp created_at = 41;
}

message User {
  message Key {
    string access_key = 1;
    string secret_key = 2;
  }
  string id = 1;
  string name = 2;
  bool suspended = 3;
  repeated Key keys = 21;
}

message SMBShare {
  message CommonConfig {
    enum MapToGuest {
      NEVER = 0;
      BAD_USER = 1;
      BAD_PASSWORD = 2;
    }
    MapToGuest map_to_guest = 1;
  }
  message SecurityConfig {
    enum Mode {
      USER = 0;
      ACTIVE_DIRECTORY = 1;
    }
    message User {
      string username = 1;
      string password = 2;
    }
    Mode mode = 1;
    repeated User local_users = 11;
    string realm = 21;
    User join_source = 22;
  }
  string name = 1;
  string namespace = 2;
  string uri = 3;
  int32 replicas = 11;
  int32 healthies = 12;
  uint64 size_bytes = 21;
  bool browsable = 31;
  bool read_only = 32;
  bool guest_ok = 41;
  repeated string valid_users = 42;
  CommonConfig common_config = 51;
  SecurityConfig security_config = 61;
}

message ListMonitorsRequest {
  string scope = 1;
  reserved 2;
}

message ListMonitorsResponse {
  repeated Monitor monitors = 1;
}

message ListObjectStorageDaemonsRequest {
  string scope = 1;
  reserved 2;
}

message ListObjectStorageDaemonsResponse {
  repeated ObjectStorageDaemon object_storage_daemons = 1;
}

message DoSMARTRequest {
  string scope = 1;
  reserved 2;
  string osd_name = 3;
}

message DoSMARTResponse {
  message Output {
    repeated string lines = 1;
  }
  map<string, Output> device_output_map = 1;
}

message ListPoolsRequest {
  string scope = 1;
  reserved 2;
  string application = 11;
}

message ListPoolsResponse {
  repeated Pool pools = 1;
}

message CreatePoolRequest {
  string scope = 1;
  reserved 2;
  string pool_name = 3;
  PoolType pool_type = 11;
  bool ec_overwrites = 21;      // erasure
  uint64 replicated_size = 31;  // replicated
  uint64 quota_bytes = 41;
  uint64 quota_objects = 42;
  repeated string applications = 61;  // cephfs, rbd, rgw
}

message UpdatePoolRequest {
  string scope = 1;
  reserved 2;
  string pool_name = 3;
  uint64 quota_bytes = 41;
  uint64 quota_objects = 42;
}

message DeletePoolRequest {
  string scope = 1;
  reserved 2;
  string pool_name = 3;
}

message ListImagesRequest {
  string scope = 1;
  reserved 2;
}

message ListImagesResponse {
  repeated Image images = 1;
}

message CreateImageRequest {
  string scope = 1;
  reserved 2;
  string pool_name = 3;
  string image_name = 4;
  uint64 object_size_bytes = 11;
  uint64 stripe_unit_bytes = 12;
  uint64 stripe_count = 13;
  uint64 quota_bytes = 21;
  bool layering = 31;
  bool exclusive_lock = 32;
  bool object_map = 33;
  bool fast_diff = 34;
  bool deep_flatten = 35;
}

message UpdateImageRequest {
  string scope = 1;
  reserved 2;
  string pool_name = 3;
  string image_name = 4;
  uint64 quota_bytes = 11;
}

message DeleteImageRequest {
  string scope = 1;
  reserved 2;
  string pool_name = 3;
  string image_name = 4;
}

message CreateImageSnapshotRequest {
  string scope = 1;
  reserved 2;
  string pool_name = 3;
  string image_name = 4;
  string snapshot_name = 5;
}

message DeleteImageSnapshotRequest {
  string scope = 1;
  reserved 2;
  string pool_name = 3;
  string image_name = 4;
  string snapshot_name = 5;
}

message RollbackImageSnapshotRequest {
  string scope = 1;
  reserved 2;
  string pool_name = 3;
  string image_name = 4;
  string snapshot_name = 5;
}

message ProtectImageSnapshotRequest {
  string scope = 1;
  reserved 2;
  string pool_name = 3;
  string image_name = 4;
  string snapshot_name = 5;
}

message UnprotectImageSnapshotRequest {
  string scope = 1;
  reserved 2;
  string pool_name = 3;
  string image_name = 4;
  string snapshot_name = 5;
}

message ListVolumesRequest {
  string scope = 1;
  reserved 2;
}

message ListVolumesResponse {
  repeated Volume volumes = 1;
}

message ListSubvolumesRequest {
  string scope = 1;
  reserved 2;
  string volume_name = 3;
  string group_name = 4;
}

message ListSubvolumesResponse {
  repeated Subvolume subvolumes = 1;
}

message CreateSubvolumeRequest {
  string scope = 1;
  reserved 2;
  string volume_name = 3;
  string group_name = 4;
  string subvolume_name = 5;
  uint64 quota_bytes = 11;
  bool export = 101;
}

message UpdateSubvolumeRequest {
  string scope = 1;
  reserved 2;
  string volume_name = 3;
  string group_name = 4;
  string subvolume_name = 5;
  uint64 quota_bytes = 11;
}

message DeleteSubvolumeRequest {
  string scope = 1;
  reserved 2;
  string volume_name = 3;
  string group_name = 4;
  string subvolume_name = 5;
}

message GrantSubvolumeExportAccessRequest {
  string scope = 1;
  reserved 2;
  string volume_name = 3;
  string subvolume_name = 4;
  string client_ip = 11;
}

message RevokeSubvolumeExportAccessRequest {
  string scope = 1;
  reserved 2;
  string volume_name = 3;
  string subvolume_name = 4;
  string client_ip = 11;
}

message CreateSubvolumeSnapshotRequest {
  string scope = 1;
  reserved 2;
  string volume_name = 3;
  string subvolume_name = 4;
  string group_name = 5;
  string snapshot_name = 6;
}

message DeleteSubvolumeSnapshotRequest {
  string scope = 1;
  reserved 2;
  string volume_name = 3;
  string subvolume_name = 4;
  string group_name = 5;
  string snapshot_name = 6;
}

message ListSubvolumeGroupsRequest {
  string scope = 1;
  reserved 2;
  string volume_name = 3;
}

message ListSubvolumeGroupsResponse {
  repeated SubvolumeGroup subvolume_groups = 1;
}

message CreateSubvolumeGroupRequest {
  string scope = 1;
  reserved 2;
  string volume_name = 3;
  string group_name = 4;
  uint64 quota_bytes = 11;
}

message UpdateSubvolumeGroupRequest {
  string scope = 1;
  reserved 2;
  string volume_name = 3;
  string group_name = 4;
  uint64 quota_bytes = 11;
}

message DeleteSubvolumeGroupRequest {
  string scope = 1;
  reserved 2;
  string volume_name = 3;
  string group_name = 4;
}

message ListBucketsRequest {
  string scope = 1;
  reserved 2;
}

message ListBucketsResponse {
  repeated Bucket buckets = 1;
}

message CreateBucketRequest {
  string scope = 1;
  reserved 2;
  string bucket_name = 3;
  string owner = 11;
  string policy = 12;
  Bucket.ACL acl = 21;
}

message UpdateBucketRequest {
  string scope = 1;
  reserved 2;
  string bucket_name = 3;
  string owner = 11;
  string policy = 12;
  Bucket.ACL acl = 21;
}

message DeleteBucketRequest {
  string scope = 1;
  reserved 2;
  string bucket_name = 3;
}

message ListUsersRequest {
  string scope = 1;
  reserved 2;
}

message ListUsersResponse {
  repeated User users = 1;
}

message CreateUserRequest {
  string scope = 1;
  reserved 2;
  string user_id = 3;
  string user_name = 11;
  bool suspended = 12;
}

message UpdateUserRequest {
  string scope = 1;
  reserved 2;
  string user_id = 3;
  string user_name = 11;
  bool suspended = 12;
}

message DeleteUserRequest {
  string scope = 1;
  reserved 2;
  string user_id = 3;
}

message CreateUserKeyRequest {
  string scope = 1;
  reserved 2;
  string user_id = 3;
}

message DeleteUserKeyRequest {
  string scope = 1;
  reserved 2;
  string user_id = 3;
  string access_key = 4;
}

message ListSMBSharesRequest {
  string scope = 1;
  string namespace = 2;
}

message ListSMBSharesResponse {
  repeated SMBShare smb_shares = 1;
}

message CreateSMBShareRequest {
  string scope = 1;
  string namespace = 2;
  string name = 3;
  uint64 size_bytes = 11;
  int32 port = 12;
  bool browsable = 21;
  bool read_only = 22;
  bool guest_ok = 31;
  repeated string valid_users = 32;
  SMBShare.CommonConfig common_config = 41;
  SMBShare.SecurityConfig security_config = 51;
}

message UpdateSMBShareRequest {
  string scope = 1;
  string namespace = 2;
  string name = 3;
  uint64 size_bytes = 11;
  int32 port = 12;
  bool browsable = 21;
  bool read_only = 22;
  bool guest_ok = 31;
  repeated string valid_users = 32;
  SMBShare.CommonConfig common_config = 41;
  SMBShare.SecurityConfig security_config = 51;
}

message ValidateSMBUserRequest {
  string realm = 1;
  string username = 2;
  string password = 3;
  string search_username = 4;
  bool tls = 5;
}

message ValidateSMBUserResponse {
  enum EntityType {
    UNKNOWN = 0;
    USER = 1;
    GROUP = 2;
  }
  bool is_valid = 1;
  EntityType entity_type = 2;
  string message = 3;
}