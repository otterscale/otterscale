edition = "2023";

package otterscale.application.v1;

import "api/annotations.proto";
import "api/registry/v1/registry.proto";
import "google/protobuf/duration.proto";
import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";

option go_package = "github.com/otterscale/otterscale/api/application/v1;pb";

service ApplicationService {
  rpc ListApplications(ListApplicationsRequest) returns (ListApplicationsResponse) {
    option (otterscale.api.feature) = {
      name: "application-enabled"
    };
  };

  rpc GetApplication(GetApplicationRequest) returns (Application) {
    option (otterscale.api.feature) = {
      name: "application-enabled"
    };
  };

  rpc RestartApplication(RestartApplicationRequest) returns (google.protobuf.Empty) {
    option (otterscale.api.feature) = {
      name: "application-enabled"
    };
  };

  rpc ScaleApplication(ScaleApplicationRequest) returns (google.protobuf.Empty) {
    option (otterscale.api.feature) = {
      name: "application-enabled"
    };
  };

  rpc DeleteApplicationPod(DeleteApplicationPodRequest) returns (google.protobuf.Empty) {
    option (otterscale.api.feature) = {
      name: "application-enabled"
    };
  };

  rpc WatchLogs(WatchLogsRequest) returns (stream WatchLogsResponse) {
    option (otterscale.api.feature) = {
      name: "application-enabled"
    };
  };

  // Due to browser limitations, bidirectional streaming cannot be used.
  rpc ExecuteTTY(ExecuteTTYRequest) returns (stream ExecuteTTYResponse) {
    option (otterscale.api.feature) = {
      name: "application-enabled"
    };
  };

  rpc WriteTTY(WriteTTYRequest) returns (google.protobuf.Empty) {
    option (otterscale.api.feature) = {
      name: "application-enabled"
    };
  };

  rpc ListReleases(ListReleasesRequest) returns (ListReleasesResponse) {
    option (otterscale.api.feature) = {
      name: "application-enabled"
    };
  };

  rpc CreateRelease(CreateReleaseRequest) returns (Release) {
    option (otterscale.api.feature) = {
      name: "application-enabled"
    };
  };

  rpc UpdateRelease(UpdateReleaseRequest) returns (Release) {
    option (otterscale.api.feature) = {
      name: "application-enabled"
    };
  };

  rpc DeleteRelease(DeleteReleaseRequest) returns (google.protobuf.Empty) {
    option (otterscale.api.feature) = {
      name: "application-enabled"
    };
  };

  rpc RollbackRelease(RollbackReleaseRequest) returns (google.protobuf.Empty) {
    option (otterscale.api.feature) = {
      name: "application-enabled"
    };
  };

  rpc ListConfigMaps(ListConfigMapsRequest) returns (ListConfigMapsResponse) {
    option (otterscale.api.feature) = {
      name: "application-enabled"
    };
  };

  rpc ListSecrets(ListSecretsRequest) returns (ListSecretsResponse) {
    option (otterscale.api.feature) = {
      name: "application-enabled"
    };
  };

  rpc ListNamespaces(ListNamespacesRequest) returns (ListNamespacesResponse);

  rpc ListStorageClasses(ListStorageClassesRequest) returns (ListStorageClassesResponse);
}

message Release {
  string namespace = 1;
  string name = 2;
  int32 revision = 3;
  otterscale.registry.v1.Chart chart = 11;
}

message Namespace {
  string name = 1;
  map<string, string> labels = 2;
  google.protobuf.Timestamp created_at = 11;
}

message Application {
   enum Type {
    TYPE_UNKNOWN = 0;
    TYPE_DEPLOYMENT = 1;
    TYPE_STATEFUL_SET = 2;
    TYPE_DAEMON_SET = 3;
  }
  message Condition {
    string type = 1;
    string status = 2;
    string reason = 3;
    string message = 4;
    google.protobuf.Timestamp probed_at = 201;
    google.protobuf.Timestamp transitioned_at = 202;
  }
  message Container {
    string image_name = 1;
    string image_pull_policy = 2;
  }
  message Service {
    message Port {
      int32 port = 1;
      int32 node_port = 2;
      string name = 3;
      string protocol = 4;
      string target_port = 11;
    }
    string name = 1;
    string type = 2;
    string cluster_ip = 3;
    repeated Port ports = 11;
    google.protobuf.Timestamp created_at = 201;
  }
  message Pod {
    string name = 1;
    string phase = 2;
    string ready = 3;
    string restarts = 4;
    Condition last_condition = 11;
    google.protobuf.Timestamp created_at = 201;
  }
  message PersistentVolumeClaim {
    string name = 1;
    string status = 2;
    repeated string access_modes = 3;
    string capacity = 4;
    StorageClass storage_class = 11;
    google.protobuf.Timestamp created_at = 201;
  }
  Type type = 1;
  string name = 2;
  string namespace = 3;
  map<string, string> labels = 4;
  int32 replicas = 5;
  int32 healthies = 11;
  reserved 21;
  repeated Container containers = 31;
  repeated Service services = 101;
  repeated Pod pods = 102;
  repeated PersistentVolumeClaim persistent_volume_claims = 103;
  google.protobuf.Timestamp created_at = 201;
}

message StorageClass {
  string name = 1;
  string provisioner = 2;
  string reclaim_policy = 3;
  string volume_binding_mode = 4;
  map<string, string> parameters = 5;
  google.protobuf.Timestamp created_at = 201;
}

message ConfigMap {
  string name = 1;
  string namespace = 2;
  map<string, string> labels = 3;
  map<string, string> data = 11;
  map<string, bytes> binary_data = 12;
  bool immutable = 13;
  google.protobuf.Timestamp created_at = 201;
}

message Secret {
  string name = 1;
  string namespace = 2;
  map<string, string> labels = 3;
  map<string, bytes> data = 11;
  string type = 12;
  map<string, string> string_data = 13;
  bool immutable = 14;
  google.protobuf.Timestamp created_at = 201;
}

message ListApplicationsRequest {
  string scope = 1;
  reserved 2;
}

message ListApplicationsResponse {
  repeated Application applications = 1;
  string hostname = 2;
}

message GetApplicationRequest {
  string scope = 1;
  reserved 2;
  string namespace = 3;
  string name = 4;
}

message RestartApplicationRequest {
  string scope = 1;
  reserved 2;
  string namespace = 3;
  string name = 4;
  Application.Type type = 5;
}

message ScaleApplicationRequest {
  string scope = 1;
  reserved 2;
  string namespace = 3;
  string name = 4;
  Application.Type type = 5;
  int32 replicas = 11;
}

message DeleteApplicationPodRequest {
  string scope = 1;
  reserved 2;
  string namespace = 3;
  string name = 4;
}

message WatchLogsRequest {
  string scope = 1;
  reserved 2;
  string namespace = 3;
  string pod_name = 4;
  string container_name = 5;
  google.protobuf.Duration duration = 6;
}

message WatchLogsResponse {
  string log = 1;
}

message ExecuteTTYRequest {
  string scope = 1;
  reserved 2;
  string namespace = 3;
  string pod_name = 4;
  string container_name = 5;
  repeated string command = 6;
}

message ExecuteTTYResponse {
  string session_id = 1;
  bytes stdout = 2;  // raw TTY manages stdout and stderr over the stdout stream
}

message WriteTTYRequest {
  string session_id = 1;
  bytes stdin = 2;
}

message ListReleasesRequest {
  string scope = 1;
  reserved 2;
}

message ListReleasesResponse {
  repeated Release releases = 1;
}

message CreateReleaseRequest {
  string scope = 1;
  reserved 2;
  string namespace = 3;
  string name = 4;
  bool dry_run = 5;
  string chart_ref = 11;
  string values_yaml = 12;
  map<string, string> values_map = 13;
}

message UpdateReleaseRequest {
  string scope = 1;
  reserved 2;
  string namespace = 3;
  string name = 4;
  bool dry_run = 5;
  string chart_ref = 11;
  string values_yaml = 12;
}

message DeleteReleaseRequest {
  string scope = 1;
  reserved 2;
  string namespace = 3;
  string name = 4;
  bool dry_run = 5;
}

message RollbackReleaseRequest {
  string scope = 1;
  reserved 2;
  string namespace = 3;
  string name = 4;
  bool dry_run = 5;
}

message ListConfigMapsRequest {
  string scope = 1;
  string namespace = 2;
}

message ListConfigMapsResponse {
  repeated ConfigMap config_maps = 1;
}

message ListSecretsRequest {
  string scope = 1;
  string namespace = 2;
}

message ListSecretsResponse {
  repeated Secret secrets = 1;
}

message ListStorageClassesRequest {
  string scope = 1;
  reserved 2;
}

message ListNamespacesRequest {
  string scope = 1;
  reserved 2;
}

message ListNamespacesResponse {
  repeated Namespace namespaces = 1;
}

message ListStorageClassesResponse {
  repeated StorageClass storage_classes = 1;
}
