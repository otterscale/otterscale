edition = "2023";

package otterscale.configuration.v1;

import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";

option go_package = "github.com/otterscale/otterscale/api/configuration/v1;pb";

service ConfigurationService {
  rpc GetConfiguration(GetConfigurationRequest) returns (Configuration);
  rpc UpdateNTPServer(UpdateNTPServerRequest) returns (Configuration.NTPServer);
  rpc UpdatePackageRepository(UpdatePackageRepositoryRequest) returns (Configuration.PackageRepository);
  rpc UpdateHelmRepository(UpdateHelmRepositoryRequest) returns (Configuration.HelmRepository);

  rpc CreateBootImage(CreateBootImageRequest) returns (Configuration.BootImage);
  rpc SetDefaultBootImage(SetDefaultBootImageRequest) returns (google.protobuf.Empty);
  rpc ImportBootImages(ImportBootImagesRequest) returns (google.protobuf.Empty);
  rpc IsImportingBootImages(IsImportingBootImagesRequest) returns (IsImportingBootImagesResponse);
  rpc ListBootImageSelections(ListBootImageSelectionsRequest) returns (ListBootImageSelectionsResponse);

  rpc ListTestResults(ListTestResultsRequest) returns (ListTestResultsResponse);
  rpc CreateTestResult(CreateTestResultRequest) returns (TestResult);
  rpc DeleteTestResult(DeleteTestResultRequest) returns (google.protobuf.Empty);
  rpc ListInternalObjectServices(ListInternalObjectServicesRequest) returns (ListInternalObjectServicesResponse);
}

message Configuration {
  message NTPServer {
    repeated string addresses = 1;
  }
  message PackageRepository {
    int64 id = 1;
    string name = 2;
    string url = 3;
    bool enabled = 4;
  }
  message BootImageSelection {
    string distro_series = 1;
    string name = 2;
    repeated string architectures = 3;
  }
  message BootImage {
    string source = 1;
    string distro_series = 2;
    string name = 3;
    map<string, string> architecture_status_map = 5;
    bool default = 11;
  }
  message HelmRepository {
    repeated string urls = 1;
  }
  NTPServer ntp_server = 1;
  repeated PackageRepository package_repositories = 2;
  repeated BootImage boot_images = 3;
  HelmRepository helm_repository = 4;
}

message GetConfigurationRequest {}

message UpdateNTPServerRequest {
  repeated string addresses = 1;
}

message UpdatePackageRepositoryRequest {
  int64 id = 1;
  string url = 2;
  bool skip_juju = 3;
}

message UpdateHelmRepositoryRequest {
  repeated string urls = 1;
}

message CreateBootImageRequest {
  string distro_series = 1;
  repeated string architectures = 2;
}

message SetDefaultBootImageRequest {
  string distro_series = 1;
}

message ImportBootImagesRequest {}

message IsImportingBootImagesRequest {}

message IsImportingBootImagesResponse {
  bool importing = 1;
}

message ListBootImageSelectionsRequest {}

message ListBootImageSelectionsResponse {
  repeated Configuration.BootImageSelection boot_image_selections = 1;
}

message CephBlockDevice {
  string scope_uuid = 1;
  string facility_name = 2;
}

message NetworkFileSystem {
  string endpoint = 1;
  string path = 2;
}

message InternalObjectService {
  enum Type {
    UNSPECIFIED = 0;
    CEPH = 1;
    MINIO = 2;
  }
  Type type = 1;
  string scope_uuid = 2;
  string facility_name = 3;
  string name = 4;
  string endpoint = 5;
}

message ExternalObjectService {
  string endpoint = 1;
  string access_key = 2;
  string secret_key = 3;
}

message FIO {
  message Input {
    enum AccessMode {
      READ = 0;
      WRITE = 1;
      TRIM = 2;
      READ_WRITE = 3;
      TRIM_WRITE = 4;
      RAND_READ = 5;
      RAND_WRITE = 6;
      RAND_TRIM = 7;
      RAND_RW = 8;
      RAND_TRIM_WRITE = 9;
    }
    AccessMode access_mode = 1;
    int64 job_count = 31;         // 1.13.3 Job description
    int64 run_time_seconds = 41;  // 1.13.4 Time related parameters
    int64 block_size_bytes = 71;  // 1.13.7 Block size
    int64 file_size_bytes = 91;   // 1.13.9 I/O size
    int64 io_depth = 121;         // 1.13.12 I/O depth
  }
  message Output {
    message Throughput {
      message Latency {
        int64 min_nanoseconds = 1;
        int64 max_nanoseconds = 2;
        double mean_nanoseconds = 3;
      }
      int64 io_bytes = 1;
      int64 bandwidth_bytes = 2;
      double io_per_second = 3;
      int64 total_ios = 4;
      Latency latency = 11;
    }
    Throughput read = 1;
    Throughput write = 2;
    Throughput trim = 3;
  }
  oneof target {
    CephBlockDevice ceph_block_device = 1;
    NetworkFileSystem network_file_system = 2;
  }
  Input input = 11;
  Output output = 12;
}

message Warp {
  message Input {
    enum Operation {
      GET = 0;
      PUT = 1;
      DELETE = 2;
      LIST = 3;
      STAT = 4;
      MIXED = 5;
    }
    Operation operation = 1;
    int64 duration_seconds = 21;
    int64 object_size_bytes = 31;
    int64 object_count = 32;
  }
  message Output {
    message Throughput {
      message Metrics {
        double fastest_per_second = 1;
        double median_per_second = 2;
        double slowest_per_second = 3;
      }
      double total_bytes = 1;
      double total_objects = 2;
      int64 total_operations = 3;
      Metrics bytes = 11;
      Metrics objects = 12;
    }
    Throughput get = 11;
    Throughput put = 12;
    Throughput delete = 13;
  }
  oneof target {
    InternalObjectService internal_object_service = 1;
    ExternalObjectService external_object_service = 2;
  }
  Input input = 11;
  Output output = 12;
}

message TestResult {
  enum Status {
    RUNNING = 0;
    SUCCEEDED = 1;
    FAILED = 2;
  }
  string uid = 1;
  string name = 2;
  Status status = 3;
  string created_by = 4;
  google.protobuf.Timestamp started_at = 11;
  google.protobuf.Timestamp completed_at = 12;
  oneof kind {
    FIO fio = 101;
    Warp warp = 102;
  }
}

message ListTestResultsRequest {}

message ListTestResultsResponse {
  repeated TestResult test_results = 1;
}

message CreateTestResultRequest {
  string name = 1;
  string created_by = 2;
  oneof kind {
    FIO fio = 101;
    Warp warp = 102;
  }
}

message DeleteTestResultRequest {
  string name = 1;
}

message ListInternalObjectServicesRequest {
  string scope_uuid = 1;
}

message ListInternalObjectServicesResponse {
  repeated InternalObjectService internal_object_services = 1;
}
