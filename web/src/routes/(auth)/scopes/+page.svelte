<script lang="ts">
	import { createClient, type Transport } from '@connectrpc/connect';
	import Icon from '@iconify/svelte';
	import { getContext, onMount } from 'svelte';
	import { writable, derived } from 'svelte/store';

	import { ScopeService, type Scope } from '$lib/api/scope/v1/scope_pb';
	import SquareGridImage from '$lib/assets/square-grid.svg';
	import { scopeIcon } from '$lib/components/scopes/icon';
	import { Badge } from '$lib/components/ui/badge';
	import { Button } from '$lib/components/ui/button';
	import * as Card from '$lib/components/ui/card';
	import { m } from '$lib/paraglide/messages';
	import { dynamicPaths } from '$lib/path';

	const EXCLUDED_SCOPES = ['cos', 'cos-dev', 'cos-lite'];

	const transport: Transport = getContext('transport');
	const scopeClient = createClient(ScopeService, transport);

	const scopes = writable<Scope[]>([]);
	const filteredScopes = derived(scopes, ($scopes) =>
		$scopes.filter((scope) => !EXCLUDED_SCOPES.includes(scope.name)),
	);

	async function fetchScopes() {
		try {
			const response = await scopeClient.listScopes({});
			scopes.set(response.scopes);
		} catch (error) {
			console.error('Failed to fetch scopes:', error);
		}
	}

	function getCardColumnClass(index: number, scopeCount: number): string {
		const startColumns: Record<number, string> = { 1: 'col-start-4', 2: 'col-start-3', 3: 'col-start-2' };
		return index === 0 ? startColumns[scopeCount] || '' : '';
	}

	function getScopeIndex(scopeName: string): number {
		return $scopes.findIndex((scope) => scope.name === scopeName);
	}

	let mounted = $state(false);
	onMount(async () => {
		await fetchScopes();
		mounted = true;
	});
</script>

<svelte:head>
	<title>{m.welcome_to({ name: 'OtterScale ðŸ¦¦' })}</title>
</svelte:head>

<main class="bg-sidebar relative flex min-h-screen flex-col overflow-hidden px-2 py-20 md:px-4 md:py-24">
	<!-- Background Image -->
	<div class="absolute inset-x-0 top-0 flex h-full w-full items-center justify-center opacity-100">
		<img
			src={SquareGridImage}
			alt="square-grid"
			class="[mask-image:radial-gradient(75%_75%_at_center,white,transparent)] opacity-90"
		/>
	</div>

	<!-- Header -->
	{#if mounted}
		<h2 class="text-center text-3xl font-bold tracking-tight sm:text-4xl">{m.scope_selector()}</h2>
		<p class="text-muted-foreground mt-4 text-center text-lg">{m.scope_selector_description()}</p>
	{:else}
		<h2 class="text-center text-3xl font-bold tracking-tight sm:text-4xl">{m.scope_selector_loading()}</h2>
		<Button class="text-muted-foreground mt-4 text-center text-lg" variant="ghost" size="lg" disabled>
			<Icon icon="ph:spinner-gap" class="size-6 animate-spin" />
			{m.scope_selector_loading_description()}
		</Button>
	{/if}

	<!-- Scopes Grid -->
	<div class="z-10 mx-auto grid w-full grid-cols-8 gap-4 px-4 py-10 sm:gap-6 xl:px-0 2xl:w-3/4">
		{#each $filteredScopes as scope, index}
			<a
				href={dynamicPaths.scope(scope.name).url}
				class="group col-span-2 cursor-pointer {getCardColumnClass(index, $filteredScopes.length)}"
			>
				<Card.Root>
					<Card.Header class="gap-0">
						<div class="flex items-center gap-4">
							<!-- Scope Icon -->
							<div class="bg-primary flex size-10 items-center justify-center rounded-lg">
								<Icon
									icon="{scopeIcon(getScopeIndex(scope.name))}-fill"
									class="text-primary-foreground size-6"
								/>
							</div>

							<!-- Scope Info -->
							<div class="grid -space-y-1">
								<Card.Description class="capitalize">
									{scope.status}
								</Card.Description>
								<Card.Title class="text-2xl text-nowrap">{scope.name}</Card.Title>
							</div>
						</div>

						<!-- Scope Stats and Action -->
						<Card.Action class="overflow-hidden group-hover:self-center">
							<Badge variant="outline" class="hidden group-hover:hidden lg:block">
								<span class="text-green-600">
									{m.machines()}: {scope.machineCount > 0 ? scope.machineCount : '-'} /
									{m.unit()}: {scope.unitCount > 0 ? scope.unitCount : '-'}
								</span>
							</Badge>
							<div
								class="text-muted-foreground group-hover:bg-primary group-hover:text-primary-foreground hidden size-10 items-center justify-center rounded-full transition-colors group-hover:inline-flex"
							>
								<Icon icon="ph:arrow-right" class="size-6" />
							</div>
						</Card.Action>
					</Card.Header>
				</Card.Root>
			</a>
		{/each}
	</div>
</main>
